{{> header}}

<section id="cabecera">
    <video autoplay muted loop id="video-fondo">
        <source src="videoavion.mp4" type="video/mp4">
    </video>
    <div class="contenido-cabecera"> 
        <h2>Traveling was never so easy.</h2>
        <p>In Eurotravel we offered excursions and adventures ready to enjoy. You only have to choose the destiny, we take care of the trouble. <strong>¡Get ready to write your next story with us!</strong></p>
    </div>
</section>

<div class="barra-superior">
    
    <form action="/" method="GET" class="search-form">
        <input class="form-control" 
                type="search" 
                placeholder="Busque su viaje" 
                name="searchQuery"
                value="{{searchTerm}}"> 
        
        {{#category}}
        <input type="hidden" name="category" value="{{category}}">
        {{/category}}
                
        <button class="btn btn-outline-success" type="submit">Search</button>
    </form>

    <a href="/new" class="btn button btn-dark" id="b1">Add new trip</a>

</div>

<div class="categorias-container">
    <h5>Categorías:</h5>
    <a href="/?category=Adventure&searchQuery={{searchTerm}}" 
       class="btn {{#pagination.isCategoryActive.Adventure}}btn-primary{{else}}btn-outline-primary{{/pagination.isCategoryActive.Adventure}}">
       Adventure
    </a>
    <a href="/?category=Culture&searchQuery={{searchTerm}}" 
       class="btn {{#pagination.isCategoryActive.Culture}}btn-primary{{else}}btn-outline-primary{{/pagination.isCategoryActive.Culture}}">
       Culture
    </a>
    <a href="/?category=Relax&searchQuery={{searchTerm}}" 
       class="btn {{#pagination.isCategoryActive.Relax}}btn-primary{{else}}btn-outline-primary{{/pagination.isCategoryActive.Relax}}">
       Relax
    </a>
    
    <a href="/" class="btn btn-outline-danger">ALL TRIPS</a>
</div>

<section class="container-fluid px-4 my-5">
    <h2 class="">TRIPS</h2>
    
    <div class="row g-4" id="trip-results">
        
        {{#trips}}
        <div class="col-lg-4 col-md-6 col-sm-12"> 
            <div class="card h-100 shadow-sm">
                <img src="/trip/{{_id}}/image" class="card-img-top" alt="{{name}}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{name}}</h5>
                    <p class="card-text flex-grow-1">{{description}}...</p>
                    <span class="badge bg-primary align-self-start mb-2">{{t_trip}}</span>
                    <p class="card-text text-end h4"><strong>{{price}}€</strong></p>
                    <a href="/trip/{{_id}}" class="btn btn-dark mt-auto">See Details</a> 
                </div>
            </div>
        </div>
        {{/trips}}

        {{^trips}}
        <p class="text-center text-muted col-12">No trips were found.</p>
        {{/trips}}
    </div>
    
    <div id="loading-spinner" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <p id="no-more-trips" class="text-center text-muted my-4" style="display: none;">No more trips to show.</p>

</section>

{{> footer}}

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let page = 1; 
        let isLoading = false;
        let hasMore = true; 

        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('searchQuery') || '';
        const category = urlParams.get('category') || '';
        

        const container = document.getElementById('trip-results');
        const loader = document.getElementById('loading-spinner');
        const noMoreMsg = document.getElementById('no-more-trips');

        function createTripCard(trip) {

            return `
            <div class="col-lg-4 col-md-6 col-sm-12 fade-in"> 
                <div class="card h-100 shadow-sm">
                    <img src="/trip/${trip._id}/image" class="card-img-top" alt="${trip.name}">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">${trip.name}</h5>
                        <p class="card-text flex-grow-1">${trip.description}...</p>
                        <span class="badge bg-primary align-self-start mb-2">${trip.t_trip}</span>
                        <p class="card-text text-end h4"><strong>${trip.price}€</strong></p>
                        <a href="/trip/${trip._id}" class="btn btn-dark mt-auto">See Details</a> 
                    </div>
                </div>
            </div>
            `;
        }

        async function loadMoreTrips() {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            loader.style.display = 'block';
            page++;

            try {
                
                const url = `/api/trips?page=${page}&searchQuery=${encodeURIComponent(searchQuery)}&category=${encodeURIComponent(category)}`;
                const res = await fetch(url);
                
                if (!res.ok) throw new Error('Network error');

                const data = await res.json();

                if (data.trips && data.trips.length > 0) {
                    data.trips.forEach(trip => {
                        container.insertAdjacentHTML('beforeend', createTripCard(trip));
                    });
                    hasMore = data.hasMore;
                } else {
                    hasMore = false;
                }

                if (!hasMore) {
                    noMoreMsg.style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading more trips:', error);
                hasMore = false; 
            } finally {
                isLoading = false;
                loader.style.display = 'none';
            }
        }

        
        window.addEventListener('scroll', () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                loadMoreTrips();
            }
        });
    });
</script>