{{> header}}

<style>
    
    .drop-zone {
        width: 100%;
        height: 200px;
        padding: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 2px dashed #cccccc;
        border-radius: 10px;
        cursor: pointer;
        background-color: #f9f9f9;
        position: relative;
        overflow: hidden;
        transition: border 0.3s ease, background-color 0.3s ease;
    }
    .drop-zone:hover, .drop-zone.dragover {
        border-color: #000;
        background-color: #e9ecef;
    }
    .drop-zone__input { display: none; }
    .drop-zone__prompt { font-size: 1.1rem; color: #666; pointer-events: none; }
    .drop-zone__thumb {
        width: 100%; height: 100%; object-fit: cover;
        border-radius: 10px; display: none;
    }

    .remove-image-btn {
        position: absolute; top: 10px; right: 10px;
        background: rgba(255, 0, 0, 0.7); color: white;
        border: none; border-radius: 50%; width: 30px; height: 30px;
        cursor: pointer; display: none; align-items: center; justify-content: center;
        font-weight: bold; z-index: 10;
    }
    .remove-image-btn:hover { background: rgba(255, 0, 0, 1); }
</style>

<div class="form-align">
    <div class="form-container">
        <h2>
            {{#isEditing}}Edit Trip: {{formData.name}}{{/isEditing}}
            {{^isEditing}}New Trip{{/isEditing}}
        </h2>

        {{#errors}}
        <div class="alert alert-danger">
            <ul>{{#errors}} <li>{{.}}</li> {{/errors}}</ul>
        </div>
        {{/errors}}

        <form id="tripForm" 
              action="{{#isEditing}}/edit/trip/{{tripId}}{{/isEditing}}{{^isEditing}}/new{{/isEditing}}" 
              method="POST" 
              enctype="multipart/form-data" 
              novalidate
              data-is-editing="{{#isEditing}}true{{/isEditing}}{{^isEditing}}false{{/isEditing}}"
              data-current-image="{{formData.image}}">
            
            {{#isEditing}}<input type="hidden" id="tripId" value="{{tripId}}">{{/isEditing}}

            <div class="mb-3">
                <label for="name" class="form-label">Main city (Name):</label>
                <input type="text" class="form-control" id="name" name="name" required minlength="3" value="{{formData.name}}">
                <div id="nameFeedback" class="invalid-feedback">Name must start with a capital letter, have at least 3 chars.</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description:</label>
                <textarea class="form-control" id="description" name="description" rows="4" required minlength="10" maxlength="200">{{formData.description}}</textarea>
                <div class="invalid-feedback">Description must be between 10 and 200 characters.</div>
            </div>

            <div class="mb-3">
                <label for="duration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="duration" name="duration" required min="1" max="100" value="{{formData.duration}}">
                <div class="invalid-feedback">Duration must be between 1 and 100 days.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Image:</label>
                <input type="hidden" name="remove_image" id="remove_image" value="false">

                <div class="drop-zone" id="dropZone">
                    <span class="drop-zone__prompt">Drop file here or click to upload</span>
                    <input type="file" name="image" id="imageInput" class="drop-zone__input" accept="image/jpeg,image/jpg,image/png,image/webp">
                    
                    <img src="" alt="Preview" class="drop-zone__thumb" id="imagePreview">
                    <button type="button" class="remove-image-btn" id="removeImageBtn" title="Remove Image">&times;</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="price" class="form-label">Price (â‚¬):</label>
                <input type="number" class="form-control" id="price" name="price" required min="0" value="{{formData.price}}">
                <div class="invalid-feedback">Price must be a positive number.</div>
            </div>

            <div class="mb-3">
                <label for="t_trip" class="form-label">Type of trip:</label>
                <select class="form-select" id="t_trip" name="t_trip" required>
                    <option value="">Select a type</option>
                    <option value="Adventure" {{#t_trip.adventure}}selected{{/t_trip.adventure}}>Adventure</option>
                    <option value="Culture" {{#t_trip.culture}}selected{{/t_trip.culture}}>Culture</option>
                    <option value="Relax" {{#t_trip.relax}}selected{{/t_trip.relax}}>Relax</option>
                </select>
                <div class="invalid-feedback">Please select a type of trip.</div>
            </div>

            <div class="mb-3 d-flex align-items-center gap-3">
                <label class="form-label mb-0">Need a flight?</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="flight" name="flight" {{#formData.flight}}checked{{/formData.flight}}>
                </div>
            </div>

            <div class="mb-3 d-flex align-items-center gap-3">
                <label class="form-label mb-0">Is it international?</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="national" name="national" {{#formData.national}}checked{{/formData.national}}>
                </div>
            </div>

            <div class="mb-3">
                <label for="max_travellers" class="form-label">People:</label>
                <input type="number" class="form-control" id="max_travellers" name="max_travellers" required min="1" value="{{formData.max_travellers}}">
                <div class="invalid-feedback">Must be at least 1 person.</div>
            </div>
            
            <button type="submit" class="btn button btn-dark" id="submitBtn">
                {{#isEditing}}Update Trip{{/isEditing}}{{^isEditing}}Create{{/isEditing}}
            </button>
            <a href="/" class="btn button btn-dark">Cancel</a> 
        </form>
    </div>
</div>

<div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Error</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="errorModalBody">An error occurred.</div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<script src="/js/script.js"></script>

{{> footer}}