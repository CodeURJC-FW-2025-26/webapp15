{{> header}}

<div class="form-align">
    <div class="form-container">
        <h2>
            {{#isEditing}}Edit Trip: {{formData.name}}{{/isEditing}}
            {{^isEditing}}New Trip{{/isEditing}}
        </h2>

        {{#errors}}
        <div class="alert alert-danger">
            <ul>
                {{#errors}} <li>{{.}}</li> {{/errors}}
            </ul>
        </div>
        {{/errors}}

        <form id="tripForm" action="{{#isEditing}}/edit/trip/{{tripId}}{{/isEditing}}{{^isEditing}}/new{{/isEditing}}" method="POST" enctype="multipart/form-data" novalidate>
            
            {{#isEditing}}<input type="hidden" id="tripId" value="{{tripId}}">{{/isEditing}}

            <div class="mb-3">
                <label for="name" class="form-label">Main city (Name):</label>
                <input type="text" class="form-control" id="name" name="name" 
                        required 
                        minlength="3" 
                        value="{{formData.name}}">
                <div id="nameFeedback" class="invalid-feedback">
                    Name must start with a capital letter, have at least 3 chars, and be unique.
                </div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description:</label>
                <textarea class="form-control" id="description" name="description" rows="4" 
                            required 
                            minlength="10" 
                            maxlength="200" 
                            placeholder="Minimum 10 characters, maximum 200.">{{formData.description}}</textarea>
                <div class="invalid-feedback">
                    Description must be between 10 and 200 characters.
                </div>
            </div>

            <div class="mb-3">
                <label for="duration" class="form-label">Duration (days):</label>
                <input type="number" class="form-control" id="duration" name="duration" 
                        required 
                        min="1" 
                        max="100" 
                        step="1" 
                        placeholder="1"
                        value="{{formData.duration}}">
                <div class="invalid-feedback">
                    Duration must be between 1 and 100 days.
                </div>
            </div>

            <div class="mb-3">
                <label for="image" class="form-label">Image:</label>
                <input type="file" class="form-control" id="image" name="image" 
                        accept="image/jpeg,image/jpg,image/png,image/webp">
                {{#isEditing}}
                    <small class="text-muted">Leave blank to keep the current image.</small>
                {{/isEditing}}
            </div>

            <div class="mb-3">
                <label for="price" class="form-label">Price (â‚¬):</label>
                <input type="number" class="form-control" id="price" name="price" 
                        required 
                        min="0" 
                        step="1" 
                        placeholder="0"
                        value="{{formData.price}}">
                <div class="invalid-feedback">
                    Price must be a positive number.
                </div>
            </div>

            <div class="mb-3">
                <label for="t_trip" class="form-label">Type of trip:</label>
                <select class="form-select" id="t_trip" name="t_trip" required>
                    <option value="">Select a type</option>
                    <option value="Adventure" {{#formData.t_trip.adventure}}selected{{/formData.t_trip.adventure}}>Adventure</option>
                    <option value="Culture" {{#formData.t_trip.culture}}selected{{/formData.t_trip.culture}}>Culture</option>
                    <option value="Relax" {{#formData.t_trip.relax}}selected{{/formData.t_trip.relax}}>Relax</option>
                </select>
                <div class="invalid-feedback">
                    Please select a type of trip.
                </div>
            </div>

            <div class="mb-3 d-flex align-items-center gap-3">
                <label class="form-label mb-0">Need a flight?</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="flight" name="flight" {{#formData.flight}}checked{{/formData.flight}}>
                    <label class="form-check-label" for="flight"></label>
                </div>
            </div>

            <div class="mb-3 d-flex align-items-center gap-3">
                <label class="form-label mb-0">Is it international?</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="national" name="national" {{#formData.national}}checked{{/formData.national}}>
                    <label class="form-check-label" for="national"></label>
                </div>
            </div>

            <div class="mb-3">
                <label for="max_travellers" class="form-label">People:</label>
                <input type="number" class="form-control" id="max_travellers" name="max_travellers" 
                        required 
                        min="1" 
                        step="1" 
                        placeholder="1"
                        value="{{formData.max_travellers}}">
                <div class="invalid-feedback">
                    Must be at least 1 person.
                </div>
            </div>
            
            <button type="submit" class="btn button btn-dark" id="submitBtn">
                {{#isEditing}}Update Trip{{/isEditing}}{{^isEditing}}Create{{/isEditing}}
            </button>
            <a href="/" class="btn button btn-dark">Cancel</a> 
        </form>
    </div>
</div>

<div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="errorModalBody">
        An error occurred processing your request.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{{> footer}}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('tripForm');
    const nameInput = document.getElementById('name');
    const nameFeedback = document.getElementById('nameFeedback');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorModalEl = document.getElementById('errorModal');
    const errorModalBody = document.getElementById('errorModalBody');
    // Initialize bootstrap modal
    const errorModal = new bootstrap.Modal(errorModalEl);

    // 1. Client-Side Validation Logic
    function validateField(input) {
        let isValid = true;
        
        // Reset valid status
        input.classList.remove('is-invalid');
        input.classList.remove('is-valid');

        // Check HTML5 constraints (required, min, max, type)
        if (!input.checkValidity()) {
            isValid = false;
        }

        // Custom JS Checks
        if (input.id === 'name') {
            const val = input.value.trim();
            // Start with capital letter
            if (!/^[A-Z]/.test(val)) {
                isValid = false;
                nameFeedback.innerText = "Name must start with a capital letter.";
            } else if (val.length < 3) {
                isValid = false;
                nameFeedback.innerText = "Name must be at least 3 characters.";
            }
        }
        
        if (input.id === 'description') {
            if (input.value.length < 10 || input.value.length > 200) isValid = false;
        }

        if (input.id === 'duration') {
            const val = parseInt(input.value);
            if (val < 1 || val > 100) isValid = false;
        }

        if (!isValid) {
            input.classList.add('is-invalid');
        } else {
            // Only add valid class if it's not empty (UI preference)
            if(input.value) input.classList.add('is-valid');
        }

        return isValid;
    }

    // Attach "blur" event to all inputs for real-time validation
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('blur', () => validateField(input));
        input.addEventListener('input', () => {
             // Remove error class as user types
             if(input.classList.contains('is-invalid')) input.classList.remove('is-invalid');
        });
    });

    // 2. AJAX Duplicate Name Check
    nameInput.addEventListener('blur', async function() {
        // First run regex validation
        if (!validateField(nameInput)) return;

        const nameVal = this.value.trim();
        const tripIdInput = document.getElementById('tripId');
        const excludeId = tripIdInput ? tripIdInput.value : '';

        try {
            const response = await fetch(`/api/check-trip-name?name=${encodeURIComponent(nameVal)}&excludeId=${excludeId}`);
            const data = await response.json();

            if (data.exists) {
                nameInput.classList.remove('is-valid');
                nameInput.classList.add('is-invalid');
                nameFeedback.innerText = "This trip name already exists. Please choose another.";
            } else {
                nameInput.classList.remove('is-invalid');
                nameInput.classList.add('is-valid');
            }
        } catch (error) {
            console.error('Error validating name:', error);
        }
    });

    // 3. AJAX Form Submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Run validation on all fields
        let isFormValid = true;
        inputs.forEach(input => {
            if (input.type !== 'hidden' && input.type !== 'file') {
                if (!validateField(input)) isFormValid = false;
            }
        });

        // Double check name duplication logic synchronously (based on class state)
        if (nameInput.classList.contains('is-invalid')) isFormValid = false;

        if (!isFormValid) {
            // Focus the first invalid element
            const firstError = form.querySelector('.is-invalid');
            if (firstError) firstError.focus();
            return;
        }

        // Show Loading
        loadingSpinner.style.display = 'flex';

        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
                // Note: Do not set Content-Type header when using FormData; fetch does it automatically with boundary
            });

            const result = await response.json();

            if (result.success) {
                // Success: Redirect
                window.location.href = result.redirectUrl;
            } else {
                // Server returned validation errors
                loadingSpinner.style.display = 'none';
                
                let errorMsg = "<ul>";
                if (result.errors && Array.isArray(result.errors)) {
                    result.errors.forEach(err => errorMsg += `<li>${err}</li>`);
                } else {
                    errorMsg += "<li>Unknown error occurred.</li>";
                }
                errorMsg += "</ul>";
                
                errorModalBody.innerHTML = errorMsg;
                errorModal.show();
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            errorModalBody.innerText = "Network or Server Error: " + error.message;
            errorModal.show();
        }
    });
});
</script>